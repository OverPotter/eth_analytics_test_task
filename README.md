# Сервис мониторинга транзакций Ethereum

Этот проект реализует два сервиса для работы с транзакциями Ethereum:

1. **cron-job сервис** — периодически получает информацию о транзакциях в блоках и сохраняет их в базу данных.
2. **API-сервис** — предоставляет информацию о кошельке с наибольшими изменениями баланса.

---

## Содержание

- [Описание сервисов](#описание-сервисов)
  - [Cron-job сервис](#cron-job-сервис)
  - [API-сервис](#api-сервис)
- [Используемые технологии](#используемые-технологии)
- [Установка и запуск](#установка-и-запуск)
- [Что можно улучшить](#что-можно-улучшить)

---

## Описание сервисов

### Cron-job сервис

Этот сервис раз в минуту запрашивает у Etherscan API номер последнего блока и извлекает из него список транзакций, начиная с блока `19000000`. Данные сохраняются в PostgreSQL.

**API Etherscan:**
- Получение номера последнего блока:
```https://api.etherscan.io/api?module=proxy&action=eth_blockNumber```
- Получение информации о блоке:
```https://api.etherscan.io/api?module=proxy&action=eth_getBlockByNumber&tag=<block_number>&boolean=true```

**Данные, которые сохраняются:**
- Номер блока.
- Адрес отправителя (`from`).
- Адрес получателя (`to`).
- Сумма перевода (`value`).

### API-сервис

Этот сервис предоставляет информацию о кошельке с наибольшими изменениями баланса за последние 100 блоков.

**API:**
- `GET /api/v1/eth-analytics-service/transactions/top-balance-change`  
Возвращает адрес кошелька, баланс которого изменился больше всех по абсолютной величине.

---

## Используемые технологии

- **Язык**: Python
- **Фреймворки**: FastAPI, asyncio
- **База данных**: PostgreSQL, SQLAlchemy, Alembic
- **Контейнеризация**: Docker, Docker Compose
- **Фоновые задачи**: Cron
- **Линтеры**: black, isort, ruff
- **CI/CD**: GitHub Actions

---

## Установка и запуск

1. ### Клонируйте репозиторий:
   ```bash
   git clone <repository_url>
   cd <repository_directory>```
2. ### Убедитесь, что установлен Docker и Docker Compose.
3. ### Перейдите в корневую директорию проекта, где находится папка docker:
```bash
cd docker/
```
4. ### Создание файлов ```.env``` на основе ```.env.local```:
    Для каждого подкаталога в папке docker вам нужно будет создать файл ```.env``` на основе существующего ```.env.local```.

    Выполните следующие шаги для каждого подкаталога:
- Перейдите в подкаталог (например, ```cron_service```):
```bash
cd cron_service
```
- Создайте файл ```.env```, скопировав содержимое из ```.env.local``` (подойдет для локального запуска):
```bash
cp .env.local .env
```
- Повторите эти шаги для всех остальных подкаталогов (```rest_api_service```, ```postgresql```, ):
```bash
cd ../rest_api_service
cp .env.local .env

cd ../postgresql
cp .env.local .env
```
5. ### Запустите сервисы:
```bash
make up
```
6. ### Тестирование API:
    Используйте интерактивную документацию Swagger:
- API-сервис: http://0.0.0.0:8000/api/v1/eth-analytics-service/docs

---

## Что можно улучшить

### Один репозиторий = один сервис
Разделить cron-job сервис и API-сервис по разным репозиториям, чтобы упростить их независимую разработку, развертывание и масштабирование.

### Оптимизация хранения данных
Хранение всех транзакций в одном месте может быстро разрастаться. Можно использовать партиционирование таблиц в PostgreSQL по номерам блоков или времени.

### Обработка ошибок
Добавить повторные запросы к API в случае ошибок, а также логирование ошибок для упрощения отладки.

### Тестирование
Добавить юнит-тесты для проверки работы API и сохранения данных в БД.

### Документация
Расширить документацию по API и cron-job сервису, добавив примеры использования.

### Обсудить задачи с командой
Провести ревью архитектуры и обсудить возможные улучшения перед развертыванием в продакшн.
